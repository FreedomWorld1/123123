<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>CC-Shop Finanzsystem</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.bunny.net/css?family=inter:400,500,600,700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDKs (VOR Ihrem Skript) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        /* Ihre CSS-Styles bleiben gleich */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); 
            min-height: 100vh; 
            color: #e2e8f0;
            padding: 20px;
        }
        /* ... restliche CSS-Styles ... */
    </style>
</head>
<body>
    <div class="container">
        <!-- Ihr HTML bleibt gleich -->
    </div>
    
    <!-- Script-Tag am ENDE des body Tags -->
    <script>
        // 1. ZUERST Firebase Konfiguration definieren
        const firebaseConfig = {
            apiKey: "AIzaSyCw4nadHCIRcouTJJoQ3ElToiVVFr5Rufo",
            authDomain: "khusland-b7d13.firebaseapp.com",
            projectId: "khusland-b7d13",
            storageBucket: "khusland-b7d13.firebasestorage.app",
            messagingSenderId: "69573193613",
            appId: "1:69573193613:web:86c4d839281b1e343cd7c4",
            measurementId: "G-JSCWR4207G"
        };

        // 2. Globale Variablen
        let db, transactionsRef, balanceRef;
        let holdTransactions = [];
        let availableBalance = 0;
        let holdDistributionChart = null;
        let currentPeriod = 'today';
        
        // 3. Initialisierung wenn DOM geladen ist
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM geladen, starte Initialisierung...');
            updateDebugInfo('DOM geladen');
            
            // Setup vor Firebase
            initializeHoldChart();
            setupAllEventListeners();
            
            // Heutiges Datum setzen
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('holdDate').value = today;
            updateReleaseDate();
            
            // 4. Firebase erst NACH DOM initialisieren
            initializeFirebase();
        });
        
        // 5. Firebase Initialisierung
        async function initializeFirebase() {
            try {
                updateDebugInfo('Initialisiere Firebase...');
                
                // Prüfen ob Firebase verfügbar ist
                if (typeof firebase === 'undefined') {
                    throw new Error('Firebase SDK nicht geladen!');
                }
                
                // Firebase App initialisieren
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                transactionsRef = db.collection('finanz_transactions');
                balanceRef = db.collection('finanz_balance').doc('current');
                
                updateDebugInfo('Firebase initialisiert, lade Daten...');
                
                // Daten laden
                await loadDataFromFirebase();
                
                updateDebugInfo('Daten geladen, System bereit');
                
            } catch (error) {
                console.error('Fehler bei Firebase Initialisierung:', error);
                updateDebugInfo(`Fehler: ${error.message}`);
                showNotification('Fehler bei der Verbindung zu Firebase!', 'error');
                
                // Fallback: Beispiel-Daten
                holdTransactions = [];
                availableBalance = 0;
                updateDisplay();
            }
        }

        // 6. Event Listener Setup (vereinfacht)
        function setupAllEventListeners() {
            console.log('Richte Event Listener ein...');
            
            // Modal Buttons
            document.getElementById('openHoldModalBtn').addEventListener('click', openHoldModal);
            document.getElementById('openDepositModalBtn').addEventListener('click', openDepositModal);
            document.getElementById('openWithdrawModalBtn').addEventListener('click', openWithdrawModal);
            
            // Datum Änderungen
            document.getElementById('holdDate').addEventListener('change', updateReleaseDate);
            
            // Abbrechen Buttons
            document.getElementById('cancelHoldBtn').addEventListener('click', closeHoldModal);
            document.getElementById('cancelDepositBtn').addEventListener('click', closeDepositModal);
            document.getElementById('cancelWithdrawBtn').addEventListener('click', closeWithdrawModal);
            
            // Form Submits
            document.getElementById('holdForm').addEventListener('submit', function(e) {
                e.preventDefault();
                addHoldTransaction();
            });
            
            document.getElementById('depositForm').addEventListener('submit', function(e) {
                e.preventDefault();
                addDirectDeposit();
            });
            
            document.getElementById('withdrawForm').addEventListener('submit', function(e) {
                e.preventDefault();
                processWithdrawal();
            });
            
            // Andere Buttons
            document.getElementById('refreshChartBtn').addEventListener('click', refreshChart);
            
            // Period Buttons
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentPeriod = this.getAttribute('data-period');
                    updateDisplay();
                });
            });
        }

        // 7. WICHTIGE ÄNDERUNG: Daten von Firebase laden
        async function loadDataFromFirebase() {
            try {
                // Transaktionen laden
                const transactionsSnapshot = await transactionsRef.orderBy('createdAt', 'desc').get();
                holdTransactions = [];
                
                transactionsSnapshot.forEach(doc => {
                    const data = doc.data();
                    holdTransactions.push({
                        id: doc.id,
                        ...data
                    });
                });
                
                // Balance laden oder erstellen
                const balanceDoc = await balanceRef.get();
                if (balanceDoc.exists) {
                    const balanceData = balanceDoc.data();
                    availableBalance = balanceData.amount || 0;
                } else {
                    // Initiale Balance erstellen
                    await balanceRef.set({
                        amount: 0,
                        lastUpdated: new Date().toISOString()
                    });
                    availableBalance = 0;
                }
                
                updateDisplay();
                checkPendingReleases();
                
            } catch (error) {
                console.error('Fehler beim Laden der Daten:', error);
                throw error;
            }
        }

        // 8. Hold Transaktion hinzufügen (korrigiert)
        async function addHoldTransaction() {
            const amount = parseInt(document.getElementById('holdAmount').value);
            const purchaseDate = document.getElementById('holdDate').value;
            const releaseDate = document.getElementById('releaseDate').value;
            
            if (!amount || amount <= 0) {
                showNotification('Bitte geben Sie einen gültigen Betrag ein!', 'error');
                return;
            }
            
            try {
                const transaction = {
                    amount: amount,
                    purchaseDate: purchaseDate,
                    releaseDate: releaseDate,
                    status: 'pending',
                    type: 'hold',
                    createdAt: new Date().toISOString()
                };
                
                console.log('Speichere Hold-Transaktion:', transaction);
                
                // Zu Firebase hinzufügen
                const docRef = await transactionsRef.add(transaction);
                
                // Lokal hinzufügen
                holdTransactions.unshift({
                    id: docRef.id,
                    ...transaction
                });
                
                closeHoldModal();
                showNotification(`Betrag von ${amount} $ wurde zurückgehalten`, 'success');
                updateDisplay();
                
            } catch (error) {
                console.error('Fehler:', error);
                showNotification('Fehler beim Speichern!', 'error');
            }
        }

        // 9. Direkte Einzahlung
        async function addDirectDeposit() {
            const amount = parseInt(document.getElementById('depositAmount').value);
            
            if (!amount || amount <= 0) {
                showNotification('Bitte geben Sie einen gültigen Betrag ein!', 'error');
                return;
            }
            
            try {
                // Balance aktualisieren
                await balanceRef.update({
                    amount: firebase.firestore.FieldValue.increment(amount),
                    lastUpdated: new Date().toISOString()
                });
                
                availableBalance += amount;
                
                // Transaktion speichern
                const transaction = {
                    amount: amount,
                    type: 'deposit',
                    date: new Date().toISOString().split('T')[0],
                    status: 'released',
                    createdAt: new Date().toISOString()
                };
                
                await transactionsRef.add(transaction);
                
                closeDepositModal();
                showNotification(`Einzahlung von ${amount} $ erfolgreich`, 'success');
                updateDisplay();
                
            } catch (error) {
                console.error('Fehler:', error);
                showNotification('Fehler bei der Einzahlung!', 'error');
            }
        }

        // 10. Auszahlung
        async function processWithdrawal() {
            const amount = parseInt(document.getElementById('withdrawAmount').value);
            
            if (!amount || amount <= 0) {
                showNotification('Bitte geben Sie einen gültigen Betrag ein!', 'error');
                return;
            }
            
            if (amount > availableBalance) {
                showNotification(`Nicht genügend Guthaben! Verfügbar: ${availableBalance} $`, 'error');
                return;
            }
            
            try {
                // Balance aktualisieren
                await balanceRef.update({
                    amount: firebase.firestore.FieldValue.increment(-amount),
                    lastUpdated: new Date().toISOString()
                });
                
                availableBalance -= amount;
                
                // Transaktion speichern
                const transaction = {
                    amount: amount,
                    type: 'withdrawal',
                    date: new Date().toISOString().split('T')[0],
                    status: 'released',
                    createdAt: new Date().toISOString()
                };
                
                await transactionsRef.add(transaction);
                
                closeWithdrawModal();
                showNotification(`Auszahlung von ${amount} $ erfolgreich`, 'success');
                updateDisplay();
                
            } catch (error) {
                console.error('Fehler:', error);
                showNotification('Fehler bei der Auszahlung!', 'error');
            }
        }

        // 11. Freigabedatum berechnen
        function updateReleaseDate() {
            const holdDate = document.getElementById('holdDate').value;
            if (holdDate) {
                const releaseDate = new Date(holdDate);
                releaseDate.setDate(releaseDate.getDate() + 2);
                document.getElementById('releaseDate').value = releaseDate.toISOString().split('T')[0];
            }
        }

        // 12. Modal Funktionen (kurzgefasst)
        function openHoldModal() {
            document.getElementById('holdModal').classList.add('active');
        }
        
        function openDepositModal() {
            document.getElementById('depositModal').classList.add('active');
        }
        
        function openWithdrawModal() {
            document.getElementById('withdrawModal').classList.add('active');
        }
        
        function closeHoldModal() {
            document.getElementById('holdModal').classList.remove('active');
            document.getElementById('holdForm').reset();
            document.getElementById('holdDate').value = new Date().toISOString().split('T')[0];
            updateReleaseDate();
        }
        
        function closeDepositModal() {
            document.getElementById('depositModal').classList.remove('active');
            document.getElementById('depositForm').reset();
        }
        
        function closeWithdrawModal() {
            document.getElementById('withdrawModal').classList.remove('active');
            document.getElementById('withdrawForm').reset();
        }

        // 13. Anstehende Freigaben prüfen
        async function checkPendingReleases() {
            const today = new Date().toISOString().split('T')[0];
            let anyReleased = false;
            
            for (const transaction of holdTransactions) {
                if (transaction.status === 'pending' && transaction.releaseDate <= today) {
                    transaction.status = 'released';
                    availableBalance += transaction.amount;
                    anyReleased = true;
                    
                    // In Firebase aktualisieren
                    await transactionsRef.doc(transaction.id).update({
                        status: 'released'
                    });
                    
                    await balanceRef.update({
                        amount: firebase.firestore.FieldValue.increment(transaction.amount)
                    });
                }
            }
            
            if (anyReleased) {
                updateDisplay();
                showNotification('Neue Beträge wurden freigegeben!', 'success');
            }
        }

        // 14. Anzeige aktualisieren
        function updateDisplay() {
            const today = new Date().toISOString().split('T')[0];
            
            const pendingTransactions = holdTransactions.filter(t => t.status === 'pending');
            const totalHoldBalance = pendingTransactions.reduce((sum, t) => sum + t.amount, 0);
            
            // Heute fällig
            const dueToday = pendingTransactions
                .filter(t => t.releaseDate === today)
                .reduce((sum, t) => sum + t.amount, 0);
            
            // Balances anzeigen
            document.getElementById('holdBalance').textContent = `${totalHoldBalance} $`;
            document.getElementById('availableBalance').textContent = `${availableBalance} $`;
            document.getElementById('dueToday').textContent = `${dueToday} $`;
            document.getElementById('pendingCount').textContent = pendingTransactions.length;
            
            // Chart aktualisieren
            updateHoldChart();
        }

        // 15. Hold Chart initialisieren
        function initializeHoldChart() {
            const ctx = document.getElementById('holdDistributionChart').getContext('2d');
            holdDistributionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Freigabebeträge ($)',
                        data: [],
                        backgroundColor: 'rgba(139, 92, 246, 0.7)',
                        borderColor: '#8b5cf6',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        function updateHoldChart() {
            if (!holdDistributionChart) return;
            
            const pendingTransactions = holdTransactions.filter(t => t.status === 'pending');
            const labels = [];
            const data = [];
            
            const today = new Date();
            for (let i = 0; i < 30; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() + i);
                const dateStr = date.toISOString().split('T')[0];
                
                labels.push(date.toLocaleDateString('de-DE', { 
                    weekday: 'short',
                    day: '2-digit',
                    month: '2-digit'
                }));
                
                const dayAmount = pendingTransactions
                    .filter(t => t.releaseDate === dateStr)
                    .reduce((sum, t) => sum + t.amount, 0);
                
                data.push(dayAmount);
            }
            
            holdDistributionChart.data.labels = labels;
            holdDistributionChart.data.datasets[0].data = data;
            holdDistributionChart.update();
        }

        // 16. Hilfsfunktionen
        function updateDebugInfo(message) {
            const debugElement = document.getElementById('debugInfo');
            if (debugElement) {
                debugElement.textContent = `Status: ${message}`;
            }
        }

        function showNotification(message, type = 'info', duration = 4000) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, duration);
        }

        function refreshChart() {
            updateHoldChart();
            showNotification('Chart aktualisiert', 'info');
        }

        // 17. Automatisch alle 5 Minuten prüfen
        setInterval(checkPendingReleases, 5 * 60 * 1000);
    </script>
</body>
</html>
